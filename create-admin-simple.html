<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Administrador - PeluGo (Versi√≥n Simple)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .loading {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full mx-4">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crown text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Crear Administrador</h1>
            <p class="text-gray-600 mt-2">Versi√≥n simple - Conexi√≥n directa a Firebase</p>
        </div>

        <div id="createForm">
            <form id="adminForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email del administrador
                        </label>
                        <input 
                            type="email" 
                            id="adminEmail"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="admin@pelugo.es"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Contrase√±a
                        </label>
                        <input 
                            type="password" 
                            id="adminPassword"
                            required
                            minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="M√≠nimo 6 caracteres"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre completo
                        </label>
                        <input 
                            type="text" 
                            id="adminName"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Tu nombre completo"
                        >
                    </div>

                                         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium mb-1">Debug Mejorado</p>
                                <p>Esta versi√≥n incluye logging detallado. Abre la consola (F12) para ver los detalles del proceso.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button 
                    type="submit"
                    class="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-3 rounded-lg font-medium"
                >
                    <i class="fas fa-crown mr-2"></i>
                    Crear Administrador
                </button>
            </form>
        </div>

        <div id="successMessage" class="hidden text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">¬°Administrador Creado!</h2>
            <p class="text-gray-600 mb-6">El usuario administrador ha sido creado correctamente.</p>
            <div class="space-y-3">
                <button 
                    onclick="goToAdminPanel()"
                    class="block w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium"
                >
                    Ir al Login de Admin
                </button>
                <button 
                    onclick="testAdminAccess()"
                    class="block w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium"
                >
                    Verificar Acceso de Admin
                </button>
                <a 
                    href="index.html"
                    class="block w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-medium"
                >
                    Volver al Inicio
                </a>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingState" class="hidden text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Creando administrador...</p>
        </div>

        <!-- Error -->
        <div id="errorState" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div class="flex">
                    <i class="fas fa-exclamation-circle text-red-600 mt-1 mr-3"></i>
                    <div class="text-sm text-red-800">
                        <p class="font-medium mb-1">Error</p>
                        <p id="errorMessage">Ha ocurrido un error al crear el administrador.</p>
                    </div>
                </div>
            </div>
            <button 
                onclick="resetForm()"
                class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-medium"
            >
                Intentar de nuevo
            </button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules - Updated to v12.0.0
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js';
        import { 
            getFirestore, 
            collection, 
            doc,
            setDoc,
            getDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            updateProfile,
            signOut
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log('Firebase v12.0.0 initialized successfully');
        console.log('Analytics enabled:', !!analytics);

        // Form handler
        document.getElementById('adminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await createAdmin();
        });

        async function createAdmin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const name = document.getElementById('adminName').value.trim();

            if (!email || !password || !name) {
                showError('Todos los campos son obligatorios');
                return;
            }

            if (password.length < 6) {
                showError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                showLoading();

                console.log('üöÄ Starting admin creation process...');
                console.log('Email:', email);
                console.log('Name:', name);

                // Step 1: Create user in Firebase Auth
                console.log('üìß Creating user in Firebase Auth...');
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                console.log('‚úÖ User created in Auth:', user.uid);
                console.log('User object:', user);

                // Step 2: Update display name
                console.log('üë§ Updating display name...');
                await updateProfile(user, {
                    displayName: name
                });

                console.log('‚úÖ Profile updated with display name');

                // Step 3: Create admin document in Firestore
                console.log('üîê Creating admin document in Firestore...');
                const adminData = {
                    uid: user.uid,  // Add uid field explicitly
                    name: name,
                    email: email,
                    role: 'admin',
                    createdAt: serverTimestamp(),
                    permissions: ['manage_salons', 'manage_users', 'view_analytics'],
                    active: true
                };

                console.log('Admin data to save:', adminData);

                await setDoc(doc(db, 'admins', user.uid), adminData);

                console.log('‚úÖ Admin document created in Firestore');

                // Step 4: Also add to users collection for role tracking
                console.log('üë• Creating user document for role tracking...');
                const userData = {
                    uid: user.uid,  // Add uid field explicitly
                    name: name,
                    email: email,
                    role: 'admin',
                    createdAt: serverTimestamp(),
                    active: true
                };

                console.log('User data to save:', userData);

                await setDoc(doc(db, 'users', user.uid), userData);

                console.log('‚úÖ User document created for role tracking');

                // Step 5: Verify documents were created
                console.log('üîç Verifying documents were created...');
                
                const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                console.log('Admin document exists:', adminDoc.exists());
                console.log('User document exists:', userDoc.exists());
                
                if (adminDoc.exists()) {
                    console.log('Admin document data:', adminDoc.data());
                }
                
                if (userDoc.exists()) {
                    console.log('User document data:', userDoc.data());
                }

                console.log('üéâ Admin creation completed successfully!');
                
                // Keep user logged in after creation
                console.log('üîê Keeping user logged in...');
                console.log('Current user after creation:', auth.currentUser);
                
                showSuccess();

            } catch (error) {
                console.error('‚ùå Error creating admin:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error object:', error);
                
                let errorMessage = 'Error desconocido';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email ya est√° en uso. Prueba con otro email o elimina el usuario existente.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contrase√±a es demasiado d√©bil. Usa al menos 6 caracteres.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inv√°lido. Verifica el formato del email.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Error de conexi√≥n. Verifica tu internet y vuelve a intentar.';
                        break;
                    case 'permission-denied':
                        errorMessage = 'Error de permisos en Firestore. Verifica las reglas de seguridad.';
                        break;
                    case 'unavailable':
                        errorMessage = 'Servicio no disponible temporalmente. Intenta en unos minutos.';
                        break;
                    default:
                        errorMessage = `Error: ${error.message || 'Error desconocido al crear el administrador'}`;
                }
                
                showError(errorMessage);
            }
        }

        // UI Functions
        function showLoading() {
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function showSuccess() {
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successMessage').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('createForm').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        window.resetForm = function() {
            document.getElementById('createForm').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        window.goToAdminPanel = function() {
            console.log('üöÄ Redirecting to admin login...');
            console.log('Current user before redirect:', auth.currentUser);
            
            // Sign out user so they have to login properly
            if (auth.currentUser) {
                signOut(auth).then(() => {
                    console.log('üëã User signed out, redirecting to login...');
                    window.location.href = 'admin-login.html';
                }).catch((error) => {
                    console.error('Error signing out:', error);
                    window.location.href = 'admin-login.html';
                });
            } else {
                window.location.href = 'admin-login.html';
            }
        }

        window.testAdminAccess = async function() {
            console.log('üß™ Testing admin access...');
            
            try {
                const currentUser = auth.currentUser;
                console.log('Current user:', currentUser);
                
                if (!currentUser) {
                    alert('‚ùå No hay usuario logueado');
                    return;
                }
                
                console.log('User UID:', currentUser.uid);
                console.log('User Email:', currentUser.email);
                console.log('User Display Name:', currentUser.displayName);
                
                // Check if admin document exists
                const adminDoc = await getDoc(doc(db, 'admins', currentUser.uid));
                console.log('Admin document exists:', adminDoc.exists());
                
                if (adminDoc.exists()) {
                    console.log('Admin document data:', adminDoc.data());
                    alert('‚úÖ Usuario es administrador. Acceso al panel permitido.');
                } else {
                    alert('‚ùå No se encontr√≥ el documento de administrador');
                }
                
                // Check user document
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                console.log('User document exists:', userDoc.exists());
                
                if (userDoc.exists()) {
                    console.log('User document data:', userDoc.data());
                } else {
                    console.log('‚ùå No se encontr√≥ el documento de usuario');
                }
                
            } catch (error) {
                console.error('Error testing admin access:', error);
                alert('‚ùå Error verificando acceso: ' + error.message);
            }
        }
    </script>
</body>
</html> 