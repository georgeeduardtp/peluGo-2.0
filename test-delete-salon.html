<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Delete Salon - PeluGo</title>
    <meta name="description" content="Prueba de eliminaci√≥n de peluquer√≠as">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .loading {
            width: 20px;
            height: 20px;
            border: 3px solid #374151;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">üóëÔ∏è Test Delete Salon</h1>
                <p class="text-gray-400">Prueba de eliminaci√≥n de peluquer√≠as</p>
            </div>

            <!-- Test Controls -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üéõÔ∏è Controles de Prueba</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">ID de Peluquer√≠a:</label>
                        <input type="text" id="salonId" placeholder="salon-id" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Email de Peluquer√≠a:</label>
                        <input type="email" id="salonEmail" placeholder="peluqueria@test.com" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="testGetSalonData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                        <i class="fas fa-search mr-2"></i>Obtener Datos
                    </button>
                    <button onclick="testDeleteSalon()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">
                        <i class="fas fa-trash mr-2"></i>Simular Eliminaci√≥n
                    </button>
                    <button onclick="testCreateSalon()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Crear Peluquer√≠a Test
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üìä Resultados</h2>
                
                <div class="space-y-4">
                    <div>
                        <h3 class="font-medium mb-2">Estado Actual:</h3>
                        <div id="currentStatus" class="text-gray-400">No verificado</div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Datos de Peluquer√≠a:</h3>
                        <pre id="salonData" class="bg-gray-900 p-4 rounded-lg text-sm overflow-x-auto">No hay datos</pre>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Proceso de Eliminaci√≥n:</h3>
                        <div id="deleteProcess" class="text-gray-400">No iniciado</div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Logs:</h3>
                        <div id="logs" class="bg-gray-900 p-4 rounded-lg text-sm max-h-64 overflow-y-auto font-mono">
                            <div class="text-gray-500">Esperando acciones...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warning Section -->
            <div class="bg-red-900 border border-red-700 rounded-lg p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4 text-red-300">‚ö†Ô∏è Advertencia</h2>
                <div class="space-y-2 text-red-200">
                    <p>‚Ä¢ Esta funcionalidad elimina <strong>permanentemente</strong> todos los datos de la peluquer√≠a</p>
                    <p>‚Ä¢ Se elimina el documento de Firestore</p>
                    <p>‚Ä¢ Se elimina la cuenta de autenticaci√≥n</p>
                    <p>‚Ä¢ Se actualizan las estad√≠sticas de la aplicaci√≥n</p>
                    <p>‚Ä¢ <strong>Esta acci√≥n NO se puede deshacer</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, doc, getDoc, deleteDoc, addDoc, collection, updateDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log('üî• Firebase initialized for delete test');

        // Global functions for testing
        window.testGetSalonData = async () => {
            const salonId = document.getElementById('salonId').value.trim();
            if (!salonId) {
                log('‚ùå Por favor ingresa un ID de peluquer√≠a');
                return;
            }

            log(`üîç Obteniendo datos de peluquer√≠a: ${salonId}`);
            
            try {
                const docRef = doc(db, 'salons', salonId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    log(`‚úÖ Datos obtenidos:`);
                    log(`   - Business Name: ${data.businessName}`);
                    log(`   - Email: ${data.email}`);
                    log(`   - Contact Name: ${data.contactName}`);
                    log(`   - City: ${data.city}`);
                    log(`   - Approved: ${data.approved}`);
                    
                    updateStatus('currentStatus', `Encontrada: ${data.businessName}`, 'text-green-400');
                    document.getElementById('salonData').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('salonEmail').value = data.email || '';
                } else {
                    log(`‚ùå No se encontraron datos para ID: ${salonId}`);
                    updateStatus('currentStatus', 'No encontrada', 'text-red-400');
                    document.getElementById('salonData').textContent = 'No hay datos';
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('currentStatus', 'Error', 'text-red-400');
            }
        };

        window.testDeleteSalon = async () => {
            const salonId = document.getElementById('salonId').value.trim();
            const salonEmail = document.getElementById('salonEmail').value.trim();
            
            if (!salonId) {
                log('‚ùå Por favor ingresa un ID de peluquer√≠a');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de que quieres eliminar la peluquer√≠a?\n\n‚ö†Ô∏è Esta acci√≥n eliminar√°:\n‚Ä¢ Todos los datos de la peluquer√≠a\n‚Ä¢ La cuenta de autenticaci√≥n\n‚Ä¢ Reservas y rese√±as asociadas\n\nEsta acci√≥n NO se puede deshacer.`)) {
                log('‚ùå Eliminaci√≥n cancelada por el usuario');
                return;
            }

            log(`üóëÔ∏è Iniciando eliminaci√≥n de peluquer√≠a: ${salonId}`);
            updateDeleteProcess('Iniciando eliminaci√≥n...', 'text-yellow-400');
            
            try {
                // Step 1: Get salon data
                log(`üìã Paso 1: Obteniendo datos de la peluquer√≠a...`);
                const docRef = doc(db, 'salons', salonId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    throw new Error('No se encontraron datos de la peluquer√≠a');
                }

                const salonData = docSnap.data();
                log(`‚úÖ Datos obtenidos: ${salonData.businessName} (${salonData.email})`);

                // Step 2: Delete Firestore document
                log(`üóëÔ∏è Paso 2: Eliminando documento de Firestore...`);
                await deleteDoc(docRef);
                log(`‚úÖ Documento de Firestore eliminado`);

                // Step 3: Update city count if city exists
                if (salonData.city) {
                    log(`üèôÔ∏è Paso 3: Actualizando contador de ciudad...`);
                    try {
                        const cityRef = doc(db, 'cities', salonData.city);
                        const cityDoc = await getDoc(cityRef);
                        
                        if (cityDoc.exists()) {
                            const currentCount = cityDoc.data().count || 0;
                            await updateDoc(cityRef, { count: Math.max(0, currentCount - 1) });
                            log(`‚úÖ Contador de ciudad actualizado`);
                        }
                    } catch (cityError) {
                        log(`‚ö†Ô∏è Error actualizando contador de ciudad: ${cityError.message}`);
                    }
                }

                // Step 4: Update app stats
                log(`üìä Paso 4: Actualizando estad√≠sticas de la app...`);
                try {
                    const statsRef = doc(db, 'statistics', 'app_stats');
                    const statsDoc = await getDoc(statsRef);
                    
                    if (statsDoc.exists()) {
                        const currentStats = statsDoc.data();
                        const currentCount = currentStats.totalSalons || 0;
                        await updateDoc(statsRef, { totalSalons: Math.max(0, currentCount - 1) });
                        log(`‚úÖ Estad√≠sticas de la app actualizadas`);
                    }
                } catch (statsError) {
                    log(`‚ö†Ô∏è Error actualizando estad√≠sticas: ${statsError.message}`);
                }

                // Step 5: Log auth deletion (would need admin SDK in production)
                if (salonData.email) {
                    log(`üë§ Paso 5: Cuenta de autenticaci√≥n marcada para eliminaci√≥n: ${salonData.email}`);
                    log(`‚ÑπÔ∏è Nota: En producci√≥n, esto requerir√≠a Admin SDK o Cloud Function`);
                }

                log(`‚úÖ Peluquer√≠a eliminada correctamente`);
                updateDeleteProcess('Eliminaci√≥n completada exitosamente', 'text-green-400');
                updateStatus('currentStatus', 'Eliminada', 'text-red-400');
                
                // Clear form
                document.getElementById('salonId').value = '';
                document.getElementById('salonEmail').value = '';
                document.getElementById('salonData').textContent = 'Peluquer√≠a eliminada';
                
            } catch (error) {
                log(`‚ùå Error durante la eliminaci√≥n: ${error.message}`);
                updateDeleteProcess(`Error: ${error.message}`, 'text-red-400');
            }
        };

        window.testCreateSalon = async () => {
            const testEmail = `test-salon-${Date.now()}@example.com`;
            const testPassword = 'test123456';
            
            log(`üîß Creando peluquer√≠a de prueba: ${testEmail}`);
            
            try {
                // Create auth account
                const userCredential = await createUserWithEmailAndPassword(auth, testEmail, testPassword);
                const user = userCredential.user;
                
                log(`‚úÖ Cuenta de autenticaci√≥n creada: ${user.uid}`);

                // Create Firestore document
                const salonDoc = {
                    uid: user.uid,
                    email: testEmail,
                    businessName: `Peluquer√≠a Test ${Date.now()}`,
                    contactName: 'Admin Test',
                    createdAt: new Date(),
                    approved: false,
                    featured: false,
                    rating: 0,
                    reviewCount: 0,
                    services: [],
                    images: [],
                    city: 'Madrid',
                    address: 'Calle Test 123',
                    phone: '123456789',
                    description: 'Peluquer√≠a de prueba para testing',
                    profileStatus: 'incomplete'
                };

                const docRef = await addDoc(collection(db, 'salons'), salonDoc);
                
                log(`‚úÖ Documento de Firestore creado: ${docRef.id}`);
                log(`üìã Datos de la peluquer√≠a de prueba:`);
                log(`   - ID: ${docRef.id}`);
                log(`   - Email: ${testEmail}`);
                log(`   - Business Name: ${salonDoc.businessName}`);

                // Fill form with test data
                document.getElementById('salonId').value = docRef.id;
                document.getElementById('salonEmail').value = testEmail;
                
                updateStatus('currentStatus', `Creada: ${salonDoc.businessName}`, 'text-green-400');
                document.getElementById('salonData').textContent = JSON.stringify(salonDoc, null, 2);

                // Sign out test user
                await signOut(auth);
                log(`üö™ Usuario de prueba desconectado`);

            } catch (error) {
                log(`‚ùå Error creando peluquer√≠a de prueba: ${error.message}`);
            }
        };

        // Helper functions
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, status, className) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = className;
        }

        function updateDeleteProcess(result, className) {
            const element = document.getElementById('deleteProcess');
            element.textContent = result;
            element.className = className;
        }

        log('‚úÖ Test Delete Salon inicializado');
        log('üìù Instrucciones:');
        log('   1. Usa "Crear Peluquer√≠a Test" para crear una peluquer√≠a de prueba');
        log('   2. Usa "Obtener Datos" para verificar que existe');
        log('   3. Usa "Simular Eliminaci√≥n" para probar la eliminaci√≥n');
        log('   4. Verifica que se elimina correctamente');
    </script>
</body>
</html> 