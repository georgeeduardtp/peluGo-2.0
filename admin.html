<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - PeluGo</title>
    <meta name="description" content="Panel de administración de PeluGo">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-cut text-white text-sm"></i>
                        </div>
                        <span class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            PeluGo
                        </span>
                    </a>
                    <span class="ml-3 bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                        ADMIN
                    </span>
                </div>

                <!-- Admin Info -->
                <div class="flex items-center space-x-4">
                    <div id="adminInfo" class="text-sm text-gray-700">
                        <span>Cargando...</span>
                    </div>
                    <button 
                        id="logoutBtn"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Cerrar sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading mb-4 mx-auto"></div>
            <p class="text-gray-600">Verificando permisos de administrador...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" class="hidden">
        
        <!-- Header Stats -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Panel de Administración</h1>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-blue-100">Usuarios Totales</p>
                                <p class="text-2xl font-bold" id="totalUsers">0</p>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-green-100">Peluquerías Activas</p>
                                <p class="text-2xl font-bold" id="activeSalons">0</p>
                            </div>
                            <i class="fas fa-store text-3xl text-green-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-yellow-100">Pendientes Aprobación</p>
                                <p class="text-2xl font-bold" id="pendingSalons">0</p>
                            </div>
                            <i class="fas fa-clock text-3xl text-yellow-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-purple-100">Reservas Totales</p>
                                <p class="text-2xl font-bold" id="totalReservations">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-3xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button 
                        class="admin-tab active py-4 px-2 border-b-2 border-purple-500 text-purple-600 font-medium"
                        data-tab="salons"
                    >
                        <i class="fas fa-store mr-2"></i>
                        Gestionar Peluquerías
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                        data-tab="create-salon"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        Crear Peluquería
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                        data-tab="users"
                    >
                        <i class="fas fa-users mr-2"></i>
                        Usuarios
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                        data-tab="settings"
                    >
                        <i class="fas fa-cog mr-2"></i>
                        Configuración
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Salons Tab -->
            <div id="salonsTab" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900">Gestión de Peluquerías</h2>
                        <p class="text-gray-600">Administra las peluquerías de la plataforma</p>
                    </div>
                    
                    <!-- Filter Tabs -->
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <div class="flex space-x-4">
                            <button class="salon-filter active px-4 py-2 rounded-lg bg-purple-600 text-white font-medium" data-filter="pending">
                                Pendientes (<span id="pendingCount">0</span>)
                            </button>
                            <button class="salon-filter px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium" data-filter="approved">
                                Aprobadas (<span id="approvedCount">0</span>)
                            </button>
                            <button class="salon-filter px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium" data-filter="all">
                                Todas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Salons List -->
                    <div id="salonsList" class="p-6">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Cargando peluquerías...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Salon Tab -->
            <div id="create-salonTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Crear Credenciales de Peluquería</h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-medium text-blue-900">Nuevo flujo de registro</h4>
                                <p class="text-sm text-blue-700 mt-1">
                                    Solo creas las credenciales de acceso. La peluquería completará su perfil cuando inicie sesión por primera vez.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="createSalonForm">
                        <div class="max-w-md mx-auto space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Email de la peluquería *
                                </label>
                                <input 
                                    type="email" 
                                    id="newSalonEmail"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="peluqueria@ejemplo.com"
                                >
                                <p class="text-xs text-gray-500 mt-1">Este será su usuario para iniciar sesión</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Contraseña temporal *
                                </label>
                                <input 
                                    type="password" 
                                    id="newSalonPassword"
                                    required
                                    minlength="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Mínimo 6 caracteres"
                                >
                                <p class="text-xs text-gray-500 mt-1">Podrán cambiarla cuando completen su perfil</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre del contacto *
                                </label>
                                <input 
                                    type="text" 
                                    id="newSalonContactName"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Nombre del propietario/gerente"
                                >
                                <p class="text-xs text-gray-500 mt-1">Solo para identificar la cuenta inicialmente</p>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-2">¿Qué pasará después?</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Se creará la cuenta en estado "Perfil Incompleto"
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        El propietario recibirá las credenciales por email
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Al iniciar sesión, deberá completar información del negocio
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Una vez completado, aparecerá para aprobación
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end space-x-4">
                            <button 
                                type="button"
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50"
                                onclick="clearCreateSalonForm()"
                            >
                                Limpiar
                            </button>
                            <button 
                                type="submit"
                                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-medium"
                            >
                                <i class="fas fa-user-plus mr-2"></i>
                                Crear Credenciales
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900">Gestión de Usuarios</h2>
                        <p class="text-gray-600">Administra los usuarios registrados</p>
                    </div>
                    
                    <div id="usersList" class="p-6">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-600">Cargando usuarios...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Configuración de la Aplicación</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Estadísticas Generales</h3>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-2xl font-bold text-purple-600" id="settingsTotalUsers">0</div>
                                        <div class="text-sm text-gray-600">Usuarios</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-green-600" id="settingsTotalSalons">0</div>
                                        <div class="text-sm text-gray-600">Peluquerías</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-600" id="settingsTotalReservations">0</div>
                                        <div class="text-sm text-gray-600">Reservas</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-yellow-600" id="settingsAvgRating">-</div>
                                        <div class="text-sm text-gray-600">Rating Promedio</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Acciones de Mantenimiento</h3>
                            <div class="space-y-3">
                                <button 
                                    class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium"
                                    onclick="refreshAllData()"
                                >
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Actualizar Datos
                                </button>
                                
                                <button 
                                    class="w-full md:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium ml-0 md:ml-3"
                                    onclick="exportData()"
                                >
                                    <i class="fas fa-download mr-2"></i>
                                    Exportar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="hidden fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center max-w-md mx-4">
            <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-ban text-4xl text-red-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Acceso Denegado</h2>
            <p class="text-gray-600 mb-6">No tienes permisos de administrador para acceder a esta página.</p>
            <div class="space-y-3">
                <a 
                    href="admin-login.html"
                    class="block bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-lg font-medium"
                >
                    Iniciar Sesión como Admin
                </a>
                <a 
                    href="index.html"
                    class="block bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium"
                >
                    Volver al Inicio
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts Direct -->
    <script type="module">
        // Import Firebase modules directly - v12.0.0
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js';
        import { 
            getFirestore, 
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            updateDoc,
            deleteDoc,
            setDoc
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            updateProfile,
            signInWithEmailAndPassword
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log('🔥 Firebase v12.0.0 initialized directly in admin panel');

        // Export Firebase instances to global scope for admin.js
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        // Simplified Firebase API for admin
        window.FirebaseAuth = {
            getCurrentUser: () => auth.currentUser,
            signOut: () => signOut(auth),
            registerUser: async (email, password, additionalData, userType) => {
                try {
                    console.log('🔧 Creating user account:', email, userType);
                    
                    // Store current admin user info to re-login later
                    const currentAdminUser = auth.currentUser;
                    const adminEmail = currentAdminUser ? currentAdminUser.email : null;
                    console.log('💾 Storing admin info for re-login:', adminEmail);
                    
                    // Create user with email and password
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('✅ User account created:', user.uid);
                    
                    // Update user profile with display name
                    if (additionalData.contactName) {
                        await updateProfile(user, {
                            displayName: additionalData.contactName
                        });
                    }
                    
                    // Create user document based on type
                    const userData = {
                        email: email,
                        displayName: additionalData.contactName || email.split('@')[0],
                        role: userType,
                        createdAt: new Date(),
                        approved: false
                    };
                    
                    if (userType === 'salon') {
                        // Add salon-specific data - minimal for incomplete state
                        userData.contactName = additionalData.contactName;
                        userData.profileStatus = 'incomplete'; // New field to track completion
                        userData.featured = false;
                        userData.rating = 0;
                        userData.reviewCount = 0;
                        userData.services = [];
                        
                        // Fields that will be completed later
                        userData.businessName = '';
                        userData.phone = '';
                        userData.address = '';
                        userData.city = '';
                        userData.description = '';
                        userData.profileCompletedAt = null;
                    }
                    
                    // Save to appropriate collection
                    const collectionName = userType === 'salon' ? 'salons' : 'users';
                    await setDoc(doc(db, collectionName, user.uid), userData);
                    
                    console.log('✅ User document created in', collectionName);
                    
                    // Sign out the newly created user immediately and re-login admin
                    await signOut(auth);
                    console.log('🚪 Signed out new user');
                    
                    // Note: We can't automatically re-login the admin without their password
                    // Instead, we'll return success and let the admin handle the session
                    console.log('ℹ️ Admin will need to stay logged in or handle session manually');
                    
                    return {
                        success: true,
                        user: user,
                        data: userData,
                        needsAdminRelogin: true
                    };
                    
                } catch (error) {
                    console.error('❌ Error creating user:', error);
                    
                    let errorMessage = 'Error al crear la cuenta';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este email ya está registrado';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'La contraseña es muy débil';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email inválido';
                    }
                    
                    return {
                        success: false,
                        error: errorMessage
                    };
                }
            }
        };

        window.FirebaseData = {
            getDocument: async (collection, docId) => {
                const docRef = doc(db, collection, docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            },
            getCollection: async (collectionName, whereClause = null) => {
                let q = collection(db, collectionName);
                if (whereClause) {
                    q = query(q, where(whereClause.field, whereClause.operator, whereClause.value));
                }
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            updateDocument: async (collectionName, docId, data) => {
                const docRef = doc(db, collectionName, docId);
                await updateDoc(docRef, data);
            },
            getPendingSalons: async () => {
                const q = query(collection(db, 'salons'), where('approved', '==', false));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            approveSalon: async (salonId) => {
                const docRef = doc(db, 'salons', salonId);
                await updateDoc(docRef, {
                    approved: true,
                    featured: true,
                    approvedAt: new Date()
                });
            },
            getAppStats: async () => {
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    const salonsSnapshot = await getDocs(collection(db, 'salons'));
                    
                    return {
                        totalUsers: usersSnapshot.size,
                        totalSalons: salonsSnapshot.size,
                        totalReservations: 0 // Placeholder for now
                    };
                } catch (error) {
                    console.error('Error getting app stats:', error);
                    return {
                        totalUsers: 0,
                        totalSalons: 0,
                        totalReservations: 0
                    };
                }
            }
        };

        console.log('✅ Firebase API exposed to global scope');
        
        // Wait for auth state and then load admin.js
        onAuthStateChanged(auth, (user) => {
            console.log('🔍 Auth state changed:', user ? 'User logged in' : 'No user');
            
            // Set flag that Firebase is ready
            window.firebaseReady = true;
            
            // Load admin.js after Firebase is ready
            if (!window.adminJsLoaded) {
                const script = document.createElement('script');
                script.src = 'assets/js/admin.js';
                script.onload = () => {
                    console.log('✅ Admin.js loaded successfully');
                    window.adminJsLoaded = true;
                };
                script.onerror = () => {
                    console.error('❌ Failed to load admin.js');
                };
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html> 