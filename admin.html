<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - PeluGo</title>
    <meta name="description" content="Panel de administraci√≥n de PeluGo">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/styles.css">
    
    <!-- Configuration (must be loaded before other scripts) -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/firebase-config.js"></script>
</head>
<body class="bg-gray-900 min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center space-x-2">
                        <img src="images/logoNav.png" alt="PeluGo Logo" class="h-8 w-auto">
                        <span class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                            PeluGo
                        </span>
                    </a>
                    <span class="ml-3 bg-red-900 text-red-300 text-xs font-medium px-2.5 py-0.5 rounded-full">
                        ADMIN
                    </span>
                </div>

                <!-- Admin Info -->
                <div class="flex items-center space-x-4">
                    <div id="adminInfo" class="text-sm text-gray-300">
                        <span>Cargando...</span>
                    </div>
                    <button 
                        id="logoutBtn"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Cerrar sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loading mb-4 mx-auto"></div>
            <p class="text-gray-400">Verificando permisos de administrador...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="adminContent" class="hidden">
        
        <!-- Header Stats -->
        <div class="bg-gray-800 shadow-sm border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1 class="text-3xl font-bold text-gray-100 mb-6">Panel de Administraci√≥n</h1>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-blue-100">Usuarios Totales</p>
                                <p class="text-2xl font-bold" id="totalUsers">0</p>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-green-100">Peluquer√≠as Activas</p>
                                <p class="text-2xl font-bold" id="activeSalons">0</p>
                            </div>
                            <i class="fas fa-store text-3xl text-green-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-yellow-100">Pendientes Aprobaci√≥n</p>
                                <p class="text-2xl font-bold" id="pendingSalons">0</p>
                            </div>
                            <i class="fas fa-clock text-3xl text-yellow-200"></i>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-700 to-blue-800 text-white rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <p class="text-blue-100">Reservas Totales</p>
                                <p class="text-2xl font-bold" id="totalReservations">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-3xl text-blue-200"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-gray-800 shadow-sm border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button 
                        class="admin-tab active py-4 px-2 border-b-2 border-blue-500 text-blue-400 font-medium"
                        data-tab="salons"
                    >
                        <i class="fas fa-store mr-2"></i>
                        Gestionar Peluquer√≠as
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        data-tab="create-salon"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        Crear Peluquer√≠a
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        data-tab="web-registrations"
                    >
                        <i class="fas fa-globe mr-2"></i>
                        Registro Web
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        data-tab="users"
                    >
                        <i class="fas fa-users mr-2"></i>
                        Usuarios
                    </button>
                    <button 
                        class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                        data-tab="settings"
                    >
                        <i class="fas fa-cog mr-2"></i>
                        Configuraci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Salons Tab -->
            <div id="salonsTab" class="tab-content">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <h2 class="text-xl font-bold text-gray-100">Gesti√≥n de Peluquer√≠as</h2>
                        <p class="text-gray-400">Administra las peluquer√≠as de la plataforma</p>
                    </div>
                    
                    <!-- Filter Tabs -->
                    <div class="px-6 py-4 bg-gray-700 border-b border-gray-600">
                        <div class="flex space-x-4">
                            <button class="salon-filter active px-4 py-2 rounded-lg bg-blue-700 text-white font-medium" data-filter="pending">
                                Pendientes (<span id="pendingCount">0</span>)
                            </button>
                            <button class="salon-filter px-4 py-2 rounded-lg bg-gray-600 text-gray-300 font-medium" data-filter="approved">
                                Aprobadas (<span id="approvedCount">0</span>)
                            </button>
                            <button class="salon-filter px-4 py-2 rounded-lg bg-gray-600 text-gray-300 font-medium" data-filter="all">
                                Todas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Salons List -->
                    <div id="salonsList" class="p-6">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-400">Cargando peluquer√≠as...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Salon Tab -->
            <div id="create-salonTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 p-6">
                    <h2 class="text-xl font-bold text-gray-100 mb-6">Crear Credenciales de Peluquer√≠a</h2>
                    
                    <div class="bg-blue-900 border border-blue-700 rounded-lg p-4 mb-6">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-medium text-blue-300">Nuevo flujo de registro</h4>
                                <p class="text-sm text-blue-200 mt-1">
                                    Solo creas las credenciales de acceso. La peluquer√≠a completar√° su perfil cuando inicie sesi√≥n por primera vez.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="createSalonForm">
                        <div class="max-w-md mx-auto space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Email de la peluquer√≠a *
                                </label>
                                <input 
                                    type="email" 
                                    id="newSalonEmail"
                                    required
                                    class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="peluqueria@ejemplo.com"
                                >
                                <p class="text-xs text-gray-400 mt-1">Este ser√° su usuario para iniciar sesi√≥n</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Contrase√±a temporal *
                                </label>
                                <input 
                                    type="password" 
                                    id="newSalonPassword"
                                    required
                                    minlength="6"
                                    class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="M√≠nimo 6 caracteres"
                                >
                                <p class="text-xs text-gray-400 mt-1">Podr√°n cambiarla cuando completen su perfil</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Nombre del contacto *
                                </label>
                                <input 
                                    type="text" 
                                    id="newSalonContactName"
                                    required
                                    class="w-full px-4 py-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nombre del propietario/gerente"
                                >
                                <p class="text-xs text-gray-400 mt-1">Solo para identificar la cuenta inicialmente</p>
                            </div>

                            <div class="bg-gray-700 border border-gray-600 rounded-lg p-4">
                                <h4 class="font-medium text-gray-100 mb-2">¬øQu√© pasar√° despu√©s?</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Se crear√° la cuenta en estado "Perfil Incompleto"
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        El propietario recibir√° las credenciales por email
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Al iniciar sesi√≥n, deber√° completar informaci√≥n del negocio
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 mr-2 text-xs"></i>
                                        Una vez completado, aparecer√° para aprobaci√≥n
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end space-x-4">
                            <button 
                                type="button"
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50"
                                onclick="clearCreateSalonForm()"
                            >
                                Limpiar
                            </button>
                            <button 
                                type="submit"
                                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-medium"
                            >
                                <i class="fas fa-user-plus mr-2"></i>
                                Crear Credenciales
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Web Registrations Tab -->
            <div id="web-registrationsTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <h2 class="text-xl font-bold text-gray-100">Registros Web</h2>
                        <p class="text-gray-400">Solicitudes de registro desde el formulario web</p>
                    </div>
                    
                    <div id="webRegistrationsList" class="p-6">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-400">Cargando registros web...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                    <div class="px-6 py-4 border-b border-gray-600">
                        <h2 class="text-xl font-bold text-gray-100">Gesti√≥n de Usuarios</h2>
                        <p class="text-gray-400">Administra los usuarios registrados</p>
                    </div>
                    
                    <div id="usersList" class="p-6">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-4"></div>
                            <p class="text-gray-400">Cargando usuarios...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 p-6">
                    <h2 class="text-xl font-bold text-gray-100 mb-6">Configuraci√≥n de la Aplicaci√≥n</h2>
                    
                    <div class="space-y-8">
                        <!-- Estad√≠sticas Generales -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-100 mb-4">Estad√≠sticas Generales</h3>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-2xl font-bold text-purple-400" id="settingsTotalUsers">0</div>
                                        <div class="text-sm text-gray-300">Usuarios</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-green-400" id="settingsTotalSalons">0</div>
                                        <div class="text-sm text-gray-300">Peluquer√≠as</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-400" id="settingsTotalReservations">0</div>
                                        <div class="text-sm text-gray-300">Reservas</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-yellow-400" id="settingsAvgRating">-</div>
                                        <div class="text-sm text-gray-300">Rating Promedio</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°ficas -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Gr√°fica de Usuarios Registrados Mensuales -->
                            <div class="bg-gray-700 rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-100 mb-4">Usuarios Registrados Mensuales</h3>
                                <div class="relative h-64">
                                    <canvas id="usersMonthlyChart"></canvas>
                                </div>
                                <div class="mt-4 text-center">
                                    <div class="text-sm text-gray-400">
                                        <span id="usersChartTotal">0</span> usuarios registrados en total
                                    </div>
                                </div>
                            </div>

                            <!-- Gr√°fica de Peluquer√≠as Activas Mensuales -->
                            <div class="bg-gray-700 rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-100 mb-4">Peluquer√≠as Activas Mensuales</h3>
                                <div class="relative h-64">
                                    <canvas id="salonsMonthlyChart"></canvas>
                                </div>
                                <div class="mt-4 text-center">
                                    <div class="text-sm text-gray-400">
                                        <span id="salonsChartTotal">0</span> peluquer√≠as activas en total
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones de Mantenimiento -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-100 mb-4">Acciones de Mantenimiento</h3>
                            <div class="space-y-3">
                                <button 
                                    class="w-full md:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium"
                                    onclick="refreshAllData()"
                                >
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Actualizar Datos
                                </button>
                                
                                <button 
                                    class="w-full md:w-auto px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium ml-0 md:ml-3"
                                    onclick="exportData()"
                                >
                                    <i class="fas fa-download mr-2"></i>
                                    Exportar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="hidden fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center max-w-md mx-4">
            <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-ban text-4xl text-red-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Acceso Denegado</h2>
            <p class="text-gray-600 mb-6">No tienes permisos de administrador para acceder a esta p√°gina.</p>
            <div class="space-y-3">
                <a 
                    href="admin-login.html"
                    class="block bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-3 rounded-lg font-medium"
                >
                    Iniciar Sesi√≥n como Admin
                </a>
                <a 
                    href="index.html"
                    class="block bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium"
                >
                    Volver al Inicio
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts Direct -->
    <script type="module">
        // Import Firebase modules directly - v12.0.0
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js';
        import { 
            getFirestore, 
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            where,
            orderBy,
            updateDoc,
            deleteDoc,
            setDoc,
            addDoc
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            updateProfile,
            signInWithEmailAndPassword
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        // Firebase Configuration - Usar configuraci√≥n centralizada
        const firebaseConfig = window.getFirebaseConfig ? window.getFirebaseConfig() : {
            // Fallback configuration
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log('üî• Firebase v12.0.0 initialized directly in admin panel');

        // Export Firebase instances to global scope for admin.js
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        // Simplified Firebase API for admin
        window.FirebaseData = {
            getDocument: async (collection, docId) => {
                const docRef = doc(db, collection, docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            },
            getCollection: async (collectionName, whereClause = null) => {
                let q = collection(db, collectionName);
                if (whereClause) {
                    q = query(q, where(whereClause.field, whereClause.operator, whereClause.value));
                }
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            updateDocument: async (collectionName, docId, data) => {
                const docRef = doc(db, collectionName, docId);
                await updateDoc(docRef, data);
            },
            deleteDocument: async (collectionName, docId) => {
                const docRef = doc(db, collectionName, docId);
                await deleteDoc(docRef);
            },
            getPendingSalons: async () => {
                const q = query(collection(db, 'salons'), where('approved', '==', false));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            approveSalon: async (salonId) => {
                const docRef = doc(db, 'salons', salonId);
                await updateDoc(docRef, {
                    approved: true,
                    featured: true,
                    profileStatus: 'approved', // üÜï CR√çTICO: Actualizar profileStatus
                    approvedAt: new Date()
                });
            },
            rejectSalon: async (salonId, reason) => {
                const docRef = doc(db, 'salons', salonId);
                await updateDoc(docRef, {
                    approved: false,
                    featured: false,
                    profileStatus: 'rejected', // üÜï CR√çTICO: Actualizar profileStatus
                    rejectionReason: reason,
                    rejectedAt: new Date()
                });
                return { success: true };
            },
            updateCityCount: async (cityName, increment) => {
                try {
                    const cityRef = doc(db, 'cities', cityName);
                    const cityDoc = await getDoc(cityRef);
                    
                    if (cityDoc.exists()) {
                        const currentCount = cityDoc.data().count || 0;
                        await updateDoc(cityRef, { count: Math.max(0, currentCount + increment) });
                    }
                } catch (error) {
                    console.warn('Error updating city count:', error);
                }
            },
            updateAppStats: async (type, increment) => {
                try {
                    const statsRef = doc(db, 'statistics', 'app_stats');
                    const statsDoc = await getDoc(statsRef);
                    
                    if (statsDoc.exists()) {
                        const currentStats = statsDoc.data();
                        const field = type === 'salon' ? 'totalSalons' : 'totalUsers';
                        const currentCount = currentStats[field] || 0;
                        await updateDoc(statsRef, { [field]: Math.max(0, currentCount + increment) });
                    }
                } catch (error) {
                    console.warn('Error updating app stats:', error);
                }
            },
            getAppStats: async () => {
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    const salonsSnapshot = await getDocs(collection(db, 'salons'));
                    
                    return {
                        totalUsers: usersSnapshot.size,
                        totalSalons: salonsSnapshot.size,
                        totalReservations: 0 // Placeholder for now
                    };
                } catch (error) {
                    console.error('Error getting app stats:', error);
                    return {
                        totalUsers: 0,
                        totalSalons: 0,
                        totalReservations: 0
                    };
                }
            },
            getWebRegistrations: async () => {
                try {
                    console.log('üìã Getting web registrations...');
                    
                    const q = query(collection(db, 'web_registrations'), orderBy('registrationDate', 'desc'));
                    const snapshot = await getDocs(q);
                    
                    const registrations = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`‚úÖ Found ${registrations.length} web registrations`);
                    return registrations;
                    
                } catch (error) {
                    console.error('‚ùå Error getting web registrations:', error);
                    throw error;
                }
            },
            deleteWebRegistration: async (registrationId) => {
                try {
                    console.log(`üóëÔ∏è Deleting web registration: ${registrationId}`);
                    
                    const docRef = doc(db, 'web_registrations', registrationId);
                    await deleteDoc(docRef);
                    
                    console.log(`‚úÖ Web registration deleted: ${registrationId}`);
                    
                } catch (error) {
                    console.error('‚ùå Error deleting web registration:', error);
                    throw error;
                }
            }
        };

        window.FirebaseAuth = {
            getCurrentUser: () => auth.currentUser,
            signOut: () => signOut(auth),
            registerUser: async (email, password, userData, userType) => {
                try {
                    console.log('üîß Creating user account:', email, userType);
                    
                    // Store current admin user info to re-login later
                    const currentAdminUser = auth.currentUser;
                    const adminEmail = currentAdminUser ? currentAdminUser.email : null;
                    console.log('üíæ Storing admin info for re-login:', adminEmail);
                    
                    // Create user with email and password
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ User account created:', user.uid);
                    
                    // Update user profile with display name
                    if (userData.contactName) {
                        await updateProfile(user, {
                            displayName: userData.contactName
                        });
                    }
                    
                    // Create user document based on type
                    const userDoc = {
                        uid: user.uid,
                        email: user.email,
                        displayName: userData.contactName || userData.name || '',
                        createdAt: new Date(),
                        userType: userType,
                        ...userData
                    };
                    
                    if (userType === 'salon') {
                        userDoc.approved = false;
                        userDoc.featured = false;
                        userDoc.profileStatus = 'incomplete'; // üÜï CR√çTICO: Establecer estado inicial
                        userDoc.rating = 0;
                        userDoc.reviewCount = 0;
                        userDoc.services = [];
                        userDoc.images = [];
                        userDoc.schedule = {
                            monday: { open: "09:00", close: "19:00" },
                            tuesday: { open: "09:00", close: "19:00" },
                            wednesday: { open: "09:00", close: "19:00" },
                            thursday: { open: "09:00", close: "20:00" },
                            friday: { open: "09:00", close: "20:00" },
                            saturday: { open: "10:00", close: "18:00" },
                            sunday: { closed: true }
                        };
                    }
                    
                    // Use UID as document ID for consistency
                    const docRef = doc(db, userType === 'salon' ? 'salons' : 'users', user.uid);
                    await setDoc(docRef, userDoc);
                    
                    console.log('‚úÖ User document created in', userType === 'salon' ? 'salons' : 'users');
                    
                    // Sign out the newly created user immediately and re-login admin
                    await signOut(auth);
                    console.log('üö™ Signed out new user');
                    
                    // Note: We can't automatically re-login the admin without their password
                    // Instead, we'll return success and let the admin handle the session
                    console.log('‚ÑπÔ∏è Admin will need to stay logged in or handle session manually');
                    
                    return {
                        success: true,
                        user: user,
                        data: userDoc,
                        needsAdminRelogin: true
                    };
                    
                } catch (error) {
                    console.error('‚ùå Error creating user:', error);
                    
                    let errorMessage = 'Error al crear la cuenta';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este email ya est√° registrado';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'La contrase√±a es muy d√©bil';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email inv√°lido';
                    }
                    
                    return {
                        success: false,
                        error: errorMessage
                    };
                }
            },
            deleteUser: async (email) => {
                try {
                    // Note: This is a simplified version. In a real app, you'd need admin SDK
                    // or a Cloud Function to delete users by email
                    console.warn('‚ö†Ô∏è User deletion by email requires admin SDK or Cloud Function');
                    console.warn('‚ö†Ô∏è Email to delete:', email);
                    
                    // For now, we'll just log the email that should be deleted
                    // In production, you'd call a Cloud Function here
                    return { success: true, message: 'User deletion logged (requires admin SDK)' };
                    
                } catch (error) {
                    console.error('‚ùå Error deleting user:', error);
                    throw new Error('No se pudo eliminar la cuenta de autenticaci√≥n');
                }
            }
        };

        console.log('‚úÖ Firebase API exposed to global scope');
        
        // Wait for auth state and then load admin.js
        onAuthStateChanged(auth, (user) => {
            console.log('üîç Auth state changed:', user ? 'User logged in' : 'No user');
            
            // Set flag that Firebase is ready
            window.firebaseReady = true;
            
            // Load admin.js after Firebase is ready
            if (!window.adminJsLoaded) {
                const script = document.createElement('script');
                script.src = 'assets/js/admin.js';
                script.onload = () => {
                    console.log('‚úÖ Admin.js loaded successfully');
                    window.adminJsLoaded = true;
                };
                script.onerror = () => {
                    console.error('‚ùå Failed to load admin.js');
                };
                document.head.appendChild(script);
            }
        });
    </script>
</body>
</html> 