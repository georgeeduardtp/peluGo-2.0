<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin Charts Fix - PeluGo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuration (must be loaded before other scripts) -->
    <script src="assets/js/config.js"></script>
    
    <style>
        .loading {
            width: 20px;
            height: 20px;
            border: 3px solid #374151;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">üìä Test Admin Charts Fix</h1>
                <p class="text-gray-400">Simulaci√≥n del panel admin con gr√°ficas</p>
            </div>

            <!-- Test Controls -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üéõÔ∏è Controles de Prueba</h2>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="testLoadCharts()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                        <i class="fas fa-chart-line mr-2"></i>Cargar Gr√°ficas
                    </button>
                    <button onclick="testWaitForChartJS()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
                        <i class="fas fa-clock mr-2"></i>Esperar Chart.js
                    </button>
                    <button onclick="testCreateEmptyCharts()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg">
                        <i class="fas fa-chart-bar mr-2"></i>Gr√°ficas Vac√≠as
                    </button>
                </div>
            </div>

            <!-- Charts Section (same as admin.html) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Users Chart -->
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-100 mb-4">Usuarios Registrados Mensuales</h3>
                    <div class="relative h-64">
                        <canvas id="usersMonthlyChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-gray-400">
                            <span id="usersChartTotal">0</span> usuarios registrados en total
                        </div>
                    </div>
                </div>

                <!-- Salons Chart -->
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-100 mb-4">Peluquer√≠as Activas Mensuales</h3>
                    <div class="relative h-64">
                        <canvas id="salonsMonthlyChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-gray-400">
                            <span id="salonsChartTotal">0</span> peluquer√≠as activas en total
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="bg-gray-800 rounded-lg p-6 mt-6">
                <h2 class="text-xl font-semibold mb-4">üìù Logs</h2>
                <div id="logs" class="bg-gray-900 p-4 rounded-lg text-sm max-h-64 overflow-y-auto font-mono">
                    <div class="text-gray-500">Esperando acciones...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store chart instances
        window.usersMonthlyChart = null;
        window.salonsMonthlyChart = null;

        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // Wait for Chart.js to be available
        function waitForChartJS() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max
                
                const checkChartJS = () => {
                    attempts++;
                    
                    if (typeof Chart !== 'undefined') {
                        log('‚úÖ Chart.js is available');
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        log('‚ùå Chart.js failed to load after 5 seconds');
                        reject(new Error('Chart.js not available'));
                        return;
                    }
                    
                    log(`‚è≥ Waiting for Chart.js... (attempt ${attempts}/${maxAttempts})`);
                    setTimeout(checkChartJS, 100);
                };
                
                checkChartJS();
            });
        }

        // Get users monthly registration data (simulated)
        async function getUsersMonthlyData() {
            try {
                log('üîç Simulating users data fetch...');
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Generate sample data for last 12 months
                const currentDate = new Date();
                const months = [];
                const data = [];
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                    const monthLabel = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                    months.push(monthLabel);
                    data.push(Math.floor(Math.random() * 10)); // Random data 0-9
                }
                
                const total = data.reduce((sum, count) => sum + count, 0);
                document.getElementById('usersChartTotal').textContent = total;
                
                log(`‚úÖ Generated users data: ${total} total users`);
                return { labels: months, data, total };
                
            } catch (error) {
                log(`‚ùå Error getting users data: ${error.message}`);
                return { labels: [], data: [], total: 0 };
            }
        }

        // Get salons monthly activation data (simulated)
        async function getSalonsMonthlyData() {
            try {
                log('üîç Simulating salons data fetch...');
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Generate sample data for last 12 months
                const currentDate = new Date();
                const months = [];
                const data = [];
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                    const monthLabel = date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                    months.push(monthLabel);
                    data.push(Math.floor(Math.random() * 5)); // Random data 0-4
                }
                
                const total = data.reduce((sum, count) => sum + count, 0);
                document.getElementById('salonsChartTotal').textContent = total;
                
                log(`‚úÖ Generated salons data: ${total} total salons`);
                return { labels: months, data, total };
                
            } catch (error) {
                log(`‚ùå Error getting salons data: ${error.message}`);
                return { labels: [], data: [], total: 0 };
            }
        }

        // Create users monthly chart
        function createUsersMonthlyChart(chartData) {
            const ctx = document.getElementById('usersMonthlyChart');
            if (!ctx) {
                log('‚ùå Canvas element for users chart not found');
                return;
            }
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                log('‚ùå Chart.js is not loaded');
                return;
            }
            
            // Destroy existing chart if it exists and is a valid Chart instance
            if (window.usersMonthlyChart && typeof window.usersMonthlyChart.destroy === 'function') {
                window.usersMonthlyChart.destroy();
                log('üóëÔ∏è Destroyed existing users chart');
            }
            
            try {
                window.usersMonthlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Usuarios Registrados',
                            data: chartData.data,
                            borderColor: 'rgb(147, 51, 234)',
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(147, 51, 234)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgb(147, 51, 234)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} usuarios`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    maxRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    stepSize: 1
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                log('‚úÖ Users monthly chart created successfully');
                
            } catch (error) {
                log(`‚ùå Error creating users monthly chart: ${error.message}`);
            }
        }

        // Create salons monthly chart
        function createSalonsMonthlyChart(chartData) {
            const ctx = document.getElementById('salonsMonthlyChart');
            if (!ctx) {
                log('‚ùå Canvas element for salons chart not found');
                return;
            }
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                log('‚ùå Chart.js is not loaded');
                return;
            }
            
            // Destroy existing chart if it exists and is a valid Chart instance
            if (window.salonsMonthlyChart && typeof window.salonsMonthlyChart.destroy === 'function') {
                window.salonsMonthlyChart.destroy();
                log('üóëÔ∏è Destroyed existing salons chart');
            }
            
            try {
                window.salonsMonthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Peluquer√≠as Activas',
                            data: chartData.data,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false,
                            hoverBackgroundColor: 'rgba(34, 197, 94, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgb(34, 197, 94)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} peluquer√≠as`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    maxRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(156, 163, 175, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    stepSize: 1
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                log('‚úÖ Salons monthly chart created successfully');
                
            } catch (error) {
                log(`‚ùå Error creating salons monthly chart: ${error.message}`);
            }
        }

        // Load monthly charts data and create charts
        async function loadMonthlyCharts() {
            try {
                log('üìä Loading monthly charts data...');
                
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    log('‚ùå Chart.js is not loaded');
                    return;
                }
                
                // Get users monthly data
                let usersMonthlyData;
                try {
                    usersMonthlyData = await getUsersMonthlyData();
                    log('‚úÖ Users monthly data loaded');
                } catch (error) {
                    log(`‚ùå Error loading users data: ${error.message}`);
                    usersMonthlyData = { labels: [], data: [], total: 0 };
                }
                
                // Get salons monthly data
                let salonsMonthlyData;
                try {
                    salonsMonthlyData = await getSalonsMonthlyData();
                    log('‚úÖ Salons monthly data loaded');
                } catch (error) {
                    log(`‚ùå Error loading salons data: ${error.message}`);
                    salonsMonthlyData = { labels: [], data: [], total: 0 };
                }
                
                // Create charts even if data is empty
                createUsersMonthlyChart(usersMonthlyData);
                createSalonsMonthlyChart(salonsMonthlyData);
                
                log('‚úÖ Monthly charts loaded successfully');
                
            } catch (error) {
                log(`‚ùå Error loading monthly charts: ${error.message}`);
            }
        }

        // Global functions for testing
        window.testLoadCharts = async () => {
            log('üöÄ Starting chart load test...');
            await loadMonthlyCharts();
        };

        window.testWaitForChartJS = async () => {
            log('‚è≥ Testing Chart.js wait function...');
            try {
                await waitForChartJS();
                log('‚úÖ Chart.js wait test successful');
            } catch (error) {
                log(`‚ùå Chart.js wait test failed: ${error.message}`);
            }
        };

        window.testCreateEmptyCharts = () => {
            log('üìä Creating empty charts...');
            const emptyData = { labels: [], data: [], total: 0 };
            createUsersMonthlyChart(emptyData);
            createSalonsMonthlyChart(emptyData);
        };

        // Initialize
        log('‚úÖ Test Admin Charts Fix inicializado');
        log('üìù Instrucciones:');
        log('   1. Usa "Esperar Chart.js" para verificar que Chart.js est√© disponible');
        log('   2. Usa "Cargar Gr√°ficas" para crear gr√°ficas con datos simulados');
        log('   3. Usa "Gr√°ficas Vac√≠as" para crear gr√°ficas sin datos');
    </script>
</body>
</html> 