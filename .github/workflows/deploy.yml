name: Deploy PeluGo with Secure Firebase Config

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Inject Firebase Configuration Securely
      run: |
        echo "ğŸ” Inyectando configuraciÃ³n segura de Firebase..."
        
        # Crear archivo de configuraciÃ³n temporal con secrets
        cat > firebase-production-config.js << EOF
        // ConfiguraciÃ³n de Firebase para ProducciÃ³n - Inyectada durante build
        // NO EDITAR - Generado automÃ¡ticamente por GitHub Actions
        (function() {
          'use strict';
          
          // Configurar variables globales de Firebase de forma segura
          window.FIREBASE_API_KEY = '${{ secrets.FIREBASE_API_KEY }}';
          window.FIREBASE_AUTH_DOMAIN = '${{ secrets.FIREBASE_AUTH_DOMAIN }}';
          window.FIREBASE_PROJECT_ID = '${{ secrets.FIREBASE_PROJECT_ID }}';
          window.FIREBASE_STORAGE_BUCKET = '${{ secrets.FIREBASE_STORAGE_BUCKET }}';
          window.FIREBASE_MESSAGING_SENDER_ID = '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}';
          window.FIREBASE_APP_ID = '${{ secrets.FIREBASE_APP_ID }}';
          window.FIREBASE_MEASUREMENT_ID = '${{ secrets.FIREBASE_MEASUREMENT_ID }}';
          
          console.log('ğŸ” ConfiguraciÃ³n de Firebase cargada de forma segura desde GitHub Secrets');
          console.log('ğŸŒ Entorno: ProducciÃ³n (GitHub Pages)');
          
          // Marcar como configuraciÃ³n de producciÃ³n
          window.FIREBASE_PRODUCTION_CONFIG = true;
        })();
        EOF
        
        echo "ğŸ“ Inyectando configuraciÃ³n en archivos HTML..."
        
        # Inyectar configuraciÃ³n en todos los archivos HTML
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "   Procesando: $file"
            # Buscar la lÃ­nea que contiene env-config.js e insertar despuÃ©s
            sed -i '/env-config\.js/a\    <script src="firebase-production-config.js"></script>' "$file"
          fi
        done
        
        echo "âœ… ConfiguraciÃ³n inyectada correctamente"
        echo "ğŸ“‹ Archivos procesados:"
        ls -la *.html
        
    - name: Verify Configuration Injection
      run: |
        echo "ğŸ” Verificando que la configuraciÃ³n fue inyectada..."
        if grep -q "firebase-production-config.js" *.html; then
          echo "âœ… ConfiguraciÃ³n encontrada en archivos HTML"
        else
          echo "âŒ Error: ConfiguraciÃ³n no encontrada"
          exit 1
        fi
        
        if [ -f "firebase-production-config.js" ]; then
          echo "âœ… Archivo de configuraciÃ³n creado correctamente"
          echo "ğŸ“„ TamaÃ±o: $(wc -c < firebase-production-config.js) bytes"
        else
          echo "âŒ Error: Archivo de configuraciÃ³n no encontrado"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2