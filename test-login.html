<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - PeluGo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">🧪 Test Login Peluquería</h1>
        
        <!-- Test Form -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Probar Login</h2>
            <form id="testForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email:</label>
                        <input type="email" id="email" value="test@peluqueria.com" 
                               class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password:</label>
                        <input type="password" id="password" value="123456" 
                               class="w-full p-2 border rounded">
                    </div>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    🔐 Test Login
                </button>
            </form>
        </div>

        <!-- Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Estado</h2>
            <div id="status" class="space-y-2">
                <p>🔥 Firebase: <span id="firebaseStatus">Checking...</span></p>
                <p>👤 Usuario: <span id="userStatus">No logged in</span></p>
                <p>📋 Rol: <span id="roleStatus">Unknown</span></p>
                <p>🏪 Salon Data: <span id="salonStatus">Unknown</span></p>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="bg-gray-800 text-white rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">🐛 Debug Log</h2>
            <div id="debugLog" class="font-mono text-sm space-y-1 h-64 overflow-y-auto">
                <p>Initializing...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts Direct -->
    <script type="module">
        // Import Firebase modules directly - v12.0.0
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js';
        import { 
            getFirestore, 
            doc,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signInWithEmailAndPassword
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Debug helper
        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<p>[${timestamp}] ${message}</p>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function updateStatus(id, value, color = 'text-blue-600') {
            document.getElementById(id).innerHTML = `<span class="${color}">${value}</span>`;
        }

        // Test functions
        async function testFirebase() {
            log('🔥 Testing Firebase...');
            try {
                if (auth && db) {
                    updateStatus('firebaseStatus', 'Ready ✅', 'text-green-600');
                    log('✅ Firebase is ready');
                    return true;
                } else {
                    updateStatus('firebaseStatus', 'Error ❌', 'text-red-600');
                    log('❌ Firebase not ready');
                    return false;
                }
            } catch (error) {
                updateStatus('firebaseStatus', 'Error ❌', 'text-red-600');
                log(`❌ Firebase error: ${error.message}`);
                return false;
            }
        }

        async function testLogin(email, password) {
            log(`🔐 Testing login: ${email}`);
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                log(`✅ Login successful: ${user.uid}`);
                updateStatus('userStatus', `${user.email}`, 'text-green-600');
                
                return user;
            } catch (error) {
                log(`❌ Login failed: ${error.message}`);
                updateStatus('userStatus', 'Login failed ❌', 'text-red-600');
                return null;
            }
        }

        async function testGetRole(uid) {
            log(`🔍 Getting role for: ${uid}`);
            
            try {
                // Check admin
                const adminDoc = await getDoc(doc(db, 'admins', uid));
                if (adminDoc.exists()) {
                    log(`👑 User is admin: ${JSON.stringify(adminDoc.data())}`);
                    updateStatus('roleStatus', 'admin', 'text-purple-600');
                    return 'admin';
                }

                // Check salon
                const salonDoc = await getDoc(doc(db, 'salons', uid));
                if (salonDoc.exists()) {
                    log(`🏪 User is salon: ${JSON.stringify(salonDoc.data())}`);
                    updateStatus('roleStatus', 'salon', 'text-blue-600');
                    return 'salon';
                }

                log(`👤 User is regular user`);
                updateStatus('roleStatus', 'user', 'text-green-600');
                return 'user';
            } catch (error) {
                log(`❌ Role check error: ${error.message}`);
                updateStatus('roleStatus', 'Error ❌', 'text-red-600');
                return 'error';
            }
        }

        async function testGetSalonData(uid) {
            log(`🏪 Getting salon data for: ${uid}`);
            
            try {
                const salonDoc = await getDoc(doc(db, 'salons', uid));
                
                if (salonDoc.exists()) {
                    const data = salonDoc.data();
                    log(`✅ Salon data found:`);
                    log(`   - Profile Status: ${data.profileStatus}`);
                    log(`   - Approved: ${data.approved}`);
                    log(`   - Business Name: ${data.businessName}`);
                    log(`   - Email: ${data.email}`);
                    log(`   - Role: ${data.role}`);
                    
                    updateStatus('salonStatus', `${data.profileStatus} | approved: ${data.approved}`, 'text-green-600');
                    
                    // Determine what should happen
                    if (data.profileStatus === 'incomplete') {
                        log(`➡️ Should redirect to: complete-profile.html`);
                    } else if (data.profileStatus === 'pending_approval') {
                        log(`➡️ Should redirect to: salon-waiting.html`);
                    } else if (data.approved) {
                        log(`➡️ Should redirect to: index.html`);
                    } else {
                        log(`⚠️ Unknown status - fallback to: complete-profile.html`);
                    }
                    
                    return data;
                } else {
                    log(`❌ No salon data found`);
                    updateStatus('salonStatus', 'Not found ❌', 'text-red-600');
                    return null;
                }
            } catch (error) {
                log(`❌ Salon data error: ${error.message}`);
                updateStatus('salonStatus', 'Error ❌', 'text-red-600');
                return null;
            }
        }

        async function runFullTest(email, password) {
            log('🚀 Starting full test...');
            
            // Test Firebase
            const firebaseReady = await testFirebase();
            if (!firebaseReady) return;
            
            // Test Login
            const user = await testLogin(email, password);
            if (!user) return;
            
            // Test Role
            const role = await testGetRole(user.uid);
            if (role === 'error') return;
            
            // If salon, test salon data
            if (role === 'salon') {
                const salonData = await testGetSalonData(user.uid);
                
                if (salonData) {
                    log('🎯 TEST COMPLETE - Ready for redirect!');
                    
                    // Show what auth.js should do
                    if (salonData.profileStatus === 'incomplete') {
                        log('📋 EXPECTED: Redirect to complete-profile.html');
                    } else if (salonData.profileStatus === 'pending_approval') {
                        log('📋 EXPECTED: Redirect to salon-waiting.html');
                    } else if (salonData.approved) {
                        log('📋 EXPECTED: Redirect to index.html');
                    }
                } else {
                    log('❌ TEST FAILED - No salon data');
                }
            } else {
                log(`🎯 TEST COMPLETE - User role: ${role}`);
            }
        }

        // Form handler
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Clear log
            document.getElementById('debugLog').innerHTML = '<p>Starting test...</p>';
            
            await runFullTest(email, password);
        });

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`🔄 Auth state: User logged in (${user.email})`);
                updateStatus('userStatus', user.email, 'text-green-600');
            } else {
                log('🔄 Auth state: User logged out');
                updateStatus('userStatus', 'Not logged in', 'text-gray-600');
                updateStatus('roleStatus', 'Unknown', 'text-gray-600');
                updateStatus('salonStatus', 'Unknown', 'text-gray-600');
            }
        });

        // Initial Firebase test
        setTimeout(testFirebase, 1000);
        
        log('🚀 Test page ready');
    </script>
</body>
</html> 