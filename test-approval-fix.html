<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Approval Fix - PeluGo</title>
    <meta name="description" content="Prueba del fix de aprobaci√≥n de peluquer√≠as">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        .loading {
            width: 20px;
            height: 20px;
            border: 3px solid #374151;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-approved { color: #10b981; }
        .status-pending { color: #f59e0b; }
        .status-rejected { color: #ef4444; }
        .status-incomplete { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">üß™ Test Approval Fix</h1>
                <p class="text-gray-400">Prueba del fix de aprobaci√≥n de peluquer√≠as</p>
            </div>

            <!-- Test Controls -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üéõÔ∏è Controles de Prueba</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email de Peluquer√≠a:</label>
                        <input type="email" id="salonEmail" placeholder="peluqueria@test.com" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">UID de Peluquer√≠a:</label>
                        <input type="text" id="salonUid" placeholder="uid-de-peluqueria" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="testGetSalonData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                        <i class="fas fa-search mr-2"></i>Obtener Datos
                    </button>
                    <button onclick="testApproveSalon()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg">
                        <i class="fas fa-check mr-2"></i>Simular Aprobaci√≥n
                    </button>
                    <button onclick="testRejectSalon()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Simular Rechazo
                    </button>
                    <button onclick="testLoginFlow()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>Simular Login
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üìä Resultados</h2>
                
                <div class="space-y-4">
                    <div>
                        <h3 class="font-medium mb-2">Estado Actual:</h3>
                        <div id="currentStatus" class="text-gray-400">No verificado</div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Datos de Peluquer√≠a:</h3>
                        <pre id="salonData" class="bg-gray-900 p-4 rounded-lg text-sm overflow-x-auto">No hay datos</pre>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Flujo de Login:</h3>
                        <div id="loginFlow" class="text-gray-400">No probado</div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium mb-2">Logs:</h3>
                        <div id="logs" class="bg-gray-900 p-4 rounded-lg text-sm max-h-64 overflow-y-auto font-mono">
                            <div class="text-gray-500">Esperando acciones...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZlepx5cEcskug7ZB7kh4S56xhCnunKb0",
            authDomain: "pelugo-2025.firebaseapp.com",
            projectId: "pelugo-2025",
            storageBucket: "pelugo-2025.firebasestorage.app",
            messagingSenderId: "588352402376",
            appId: "1:588352402376:web:c8a0d71f296a80464346fd",
            measurementId: "G-4J0EQTQTVS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log('üî• Firebase initialized for approval test');

        // Global functions for testing
        window.testGetSalonData = async () => {
            const uid = document.getElementById('salonUid').value.trim();
            if (!uid) {
                log('‚ùå Por favor ingresa un UID de peluquer√≠a');
                return;
            }

            log(`üîç Obteniendo datos de peluquer√≠a: ${uid}`);
            
            try {
                const docRef = doc(db, 'salons', uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    log(`‚úÖ Datos obtenidos:`);
                    log(`   - Profile Status: ${data.profileStatus}`);
                    log(`   - Approved: ${data.approved}`);
                    log(`   - Business Name: ${data.businessName}`);
                    log(`   - Email: ${data.email}`);
                    
                    updateStatus('currentStatus', `${data.profileStatus} | approved: ${data.approved}`, 
                               data.approved ? 'status-approved' : 'status-pending');
                    
                    document.getElementById('salonData').textContent = JSON.stringify(data, null, 2);
                } else {
                    log(`‚ùå No se encontraron datos para UID: ${uid}`);
                    updateStatus('currentStatus', 'No encontrado', 'status-rejected');
                    document.getElementById('salonData').textContent = 'No hay datos';
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('currentStatus', 'Error', 'status-rejected');
            }
        };

        window.testApproveSalon = async () => {
            const uid = document.getElementById('salonUid').value.trim();
            if (!uid) {
                log('‚ùå Por favor ingresa un UID de peluquer√≠a');
                return;
            }

            log(`‚úÖ Simulando aprobaci√≥n de peluquer√≠a: ${uid}`);
            
            try {
                const docRef = doc(db, 'salons', uid);
                await updateDoc(docRef, {
                    approved: true,
                    featured: true,
                    profileStatus: 'approved', // üÜï CR√çTICO: Actualizar profileStatus
                    approvedAt: new Date()
                });
                
                log(`‚úÖ Peluquer√≠a aprobada correctamente`);
                log(`üîÑ Actualizando estado...`);
                
                // Refresh data
                setTimeout(() => {
                    window.testGetSalonData();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error al aprobar: ${error.message}`);
            }
        };

        window.testRejectSalon = async () => {
            const uid = document.getElementById('salonUid').value.trim();
            if (!uid) {
                log('‚ùå Por favor ingresa un UID de peluquer√≠a');
                return;
            }

            log(`‚ùå Simulando rechazo de peluquer√≠a: ${uid}`);
            
            try {
                const docRef = doc(db, 'salons', uid);
                await updateDoc(docRef, {
                    approved: false,
                    featured: false,
                    profileStatus: 'rejected', // üÜï CR√çTICO: Actualizar profileStatus
                    rejectionReason: 'Prueba de rechazo',
                    rejectedAt: new Date()
                });
                
                log(`‚úÖ Peluquer√≠a rechazada correctamente`);
                log(`üîÑ Actualizando estado...`);
                
                // Refresh data
                setTimeout(() => {
                    window.testGetSalonData();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error al rechazar: ${error.message}`);
            }
        };

        window.testLoginFlow = async () => {
            const uid = document.getElementById('salonUid').value.trim();
            if (!uid) {
                log('‚ùå Por favor ingresa un UID de peluquer√≠a');
                return;
            }

            log(`üîê Simulando flujo de login para: ${uid}`);
            
            try {
                const docRef = doc(db, 'salons', uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    log(`üìã Datos de login:`);
                    log(`   - Profile Status: ${data.profileStatus}`);
                    log(`   - Approved: ${data.approved}`);
                    
                    // Simulate login flow logic
                    if (data.approved === true) {
                        log(`‚û°Ô∏è RESULTADO: Redirigir a index.html (aprobada)`);
                        updateLoginFlow('Redirigir a index.html (aprobada)', 'status-approved');
                    } else if (data.profileStatus === 'incomplete') {
                        log(`‚û°Ô∏è RESULTADO: Redirigir a complete-profile.html`);
                        updateLoginFlow('Redirigir a complete-profile.html', 'status-incomplete');
                    } else if (data.profileStatus === 'pending_approval') {
                        log(`‚û°Ô∏è RESULTADO: Redirigir a salon-waiting.html`);
                        updateLoginFlow('Redirigir a salon-waiting.html', 'status-pending');
                    } else if (data.profileStatus === 'rejected') {
                        log(`‚û°Ô∏è RESULTADO: Mostrar error de rechazo`);
                        updateLoginFlow('Mostrar error de rechazo', 'status-rejected');
                    } else {
                        log(`‚û°Ô∏è RESULTADO: Fallback a complete-profile.html`);
                        updateLoginFlow('Fallback a complete-profile.html', 'status-incomplete');
                    }
                } else {
                    log(`‚ùå No se encontraron datos para el login`);
                    updateLoginFlow('Error: No se encontraron datos', 'status-rejected');
                }
            } catch (error) {
                log(`‚ùå Error en login flow: ${error.message}`);
                updateLoginFlow('Error en login flow', 'status-rejected');
            }
        };

        // Helper functions
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, status, className) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = className;
        }

        function updateLoginFlow(result, className) {
            const element = document.getElementById('loginFlow');
            element.textContent = result;
            element.className = className;
        }

        log('‚úÖ Test Approval Fix inicializado');
        log('üìù Instrucciones:');
        log('   1. Ingresa el UID de una peluquer√≠a');
        log('   2. Haz clic en "Obtener Datos" para ver el estado actual');
        log('   3. Usa "Simular Aprobaci√≥n" para probar el fix');
        log('   4. Usa "Simular Login" para verificar el flujo de redirecci√≥n');
    </script>
</body>
</html> 